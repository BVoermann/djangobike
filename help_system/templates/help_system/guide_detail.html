{% extends 'base.html' %}
{% load static %}

{% block title %}{{ guide.title }} - Interaktive Anleitung{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'help_system/css/help-system.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="card-title mb-0">
                            <i class="fas fa-route me-2"></i>
                            {{ guide.title }}
                        </h1>
                        <div>
                            <a href="{% url 'help_system:interactive_guides' %}" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-arrow-left me-1"></i>Zurück zu den Guides
                            </a>
                            <a href="{% url 'help_system:dashboard' %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-home me-1"></i>Hilfe-Übersicht
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Guide Info -->
                            <div class="mb-4">
                                <p class="lead">{{ guide.description }}</p>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">Kategorie:</small>
                                        <div><i class="fas fa-folder me-1"></i>{{ guide.category.name }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Schwierigkeitsgrad:</small>
                                        <div><i class="fas fa-signal me-1"></i>{{ guide.get_user_level_required_display }}</div>
                                    </div>
                                </div>
                                
                                {% if guide.target_url_pattern %}
                                <div class="mb-3">
                                    <small class="text-muted">Verfügbar auf:</small>
                                    <div><i class="fas fa-link me-1"></i>{{ guide.target_url_pattern }}</div>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Guide Steps Preview -->
                            <div class="mb-4">
                                <h5><i class="fas fa-list-ol me-2"></i>Schritte dieser Anleitung</h5>
                                <div class="list-group">
                                    {% for step in guide.steps %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                                    {{ step.title|default:"Schritt ohne Titel" }}
                                                </h6>
                                                <p class="mb-1">{{ step.content|default:"Keine Beschreibung verfügbar" }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="list-group-item">
                                        <div class="text-muted text-center">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Keine Schritte für diese Anleitung definiert.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- User Progress -->
                            {% if user.is_authenticated %}
                            <div class="mb-4">
                                <h5><i class="fas fa-chart-line me-2"></i>Ihr Fortschritt</h5>
                                {% if guide_progress %}
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>Fortschritt:</span>
                                            <span class="fw-bold">{{ guide_progress.current_step }} / {{ guide_progress.total_steps }}</span>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {% widthratio guide_progress.current_step guide_progress.total_steps 100 %}%">
                                            </div>
                                        </div>
                                        {% if guide_progress.completed_at %}
                                        <div class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Abgeschlossen am {{ guide_progress.completed_at|date:"d.m.Y H:i" }}
                                        </div>
                                        {% elif guide_progress.was_skipped %}
                                        <div class="text-warning">
                                            <i class="fas fa-fast-forward me-1"></i>
                                            Übersprungen
                                        </div>
                                        {% else %}
                                        <div class="text-info">
                                            <i class="fas fa-play me-1"></i>
                                            In Bearbeitung
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif has_completed %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Sie haben diese Anleitung bereits erfolgreich abgeschlossen!
                                </div>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Sie haben diese Anleitung noch nicht begonnen.
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Start Guide Button -->
                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-lg" onclick="startGuide({{ guide.id }})">
                                    <i class="fas fa-play me-2"></i>
                                    {% if has_completed %}
                                        Anleitung wiederholen
                                    {% elif guide_progress %}
                                        Anleitung fortsetzen
                                    {% else %}
                                        Anleitung starten
                                    {% endif %}
                                </button>
                                {% if guide.target_url_pattern and guide.target_url_pattern != '/*' %}
                                <a href="{{ guide.target_url_pattern|slice:':-1' }}" class="btn btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    Zur entsprechenden Seite gehen
                                </a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="col-lg-4">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Guide-Informationen</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">Schritte</small>
                                            <div class="fw-bold">{{ guide.steps|length }}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Typ</small>
                                            <div class="fw-bold">{{ guide.get_guide_type_display }}</div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">Gestartet</small>
                                            <div class="fw-bold">{{ guide.start_count }}x</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Abgeschlossen</small>
                                            <div class="fw-bold">{{ guide.completion_count }}x</div>
                                        </div>
                                    </div>
                                    {% if guide.completion_count > 0 %}
                                    <hr>
                                    <div class="text-center">
                                        <small class="text-muted">Erfolgsrate</small>
                                        <div class="fw-bold text-success">{{ guide.completion_rate|floatformat:1 }}%</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Related Content -->
                            {% if guide.related_videos.exists or guide.related_content %}
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-link me-2"></i>Verwandte Inhalte</h6>
                                </div>
                                <div class="card-body">
                                    {% if guide.related_videos.exists %}
                                    <h6 class="text-muted">Videos</h6>
                                    {% for video in guide.related_videos.all %}
                                    <div class="mb-2">
                                        <a href="{% url 'help_system:video_detail' video.id %}" class="text-decoration-none">
                                            <i class="fas fa-play-circle me-1"></i>{{ video.title }}
                                        </a>
                                    </div>
                                    {% endfor %}
                                    {% endif %}

                                    {% if guide.related_content %}
                                    <h6 class="text-muted mt-3">Zusätzliche Informationen</h6>
                                    <div class="small">{{ guide.related_content|safe }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'help_system/js/help-system.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize help system if not already done
    if (!window.helpSystem) {
        window.helpSystem = new HelpSystem();
    }
});

function startGuide(guideId) {
    // Check if guide has a target URL pattern that includes mock-simulation
    const targetUrl = '{{ guide.target_url_pattern }}';
    const guideTitle = '{{ guide.title }}';

    console.log('Starting guide with target URL:', targetUrl);

    if (targetUrl.includes('mock-simulation')) {
        // Extract view type from URL (e.g., /help/mock-simulation/procurement/ => procurement)
        const viewMatch = targetUrl.match(/mock-simulation\/(\w+)/);
        const view = viewMatch ? viewMatch[1] : 'overview';

        console.log('Extracted view:', view);

        // Check if this is the Einkauf guide (procurement guide)
        const isEinkaufGuide = view === 'procurement' && guideTitle.includes('Komponenten bestellen');

        // Open mock simulation in new window with guide ID
        // Add view parameter and explanatory mode parameter for Einkauf guide
        const mockUrl = `/help/mock-simulation/${view}/?view=${view}&guideId=${guideId}${isEinkaufGuide ? '&explanatory=true' : ''}`;
        console.log('Opening mock URL:', mockUrl);

        window.open(mockUrl, '_blank', 'width=1400,height=900');
    } else if (window.helpSystem) {
        // Start guide in current page
        window.helpSystem.startGuide(guideId);
    } else {
        console.error('Help system not initialized');
        alert('Das Hilfesystem wurde noch nicht geladen. Bitte versuchen Sie es erneut.');
    }
}
</script>
{% endblock %}