{% extends 'base.html' %}
{% load static %}

{% block title %}Interaktive Guides{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'help_system/css/help-system.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="card-title mb-0">
                            <i class="fas fa-route me-2"></i>
                            Interaktive Guides
                        </h1>
                        <a href="{% url 'help_system:dashboard' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Zur√ºck zur √úbersicht
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <p class="lead">Lass dich Schritt f√ºr Schritt durch die wichtigsten Funktionen des Simulators f√ºhren.</p>
                    
                    <!-- Filters -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="category-filter" class="form-label">Kategorie</label>
                            <select class="form-select" id="category-filter">
                                <option value="">Alle Kategorien</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="type-filter" class="form-label">Guide-Typ</label>
                            <select class="form-select" id="type-filter">
                                <option value="">Alle Typen</option>
                                <option value="onboarding">Einf√ºhrung</option>
                                <option value="walkthrough">Feature-Tour</option>
                                <option value="feature_intro">Neue Features</option>
                                <option value="troubleshooting">Probleml√∂sung</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="difficulty-filter" class="form-label">Schwierigkeitsgrad</label>
                            <select class="form-select" id="difficulty-filter">
                                <option value="">Alle Level</option>
                                <option value="beginner">Anf√§nger</option>
                                <option value="intermediate">Fortgeschritten</option>
                                <option value="advanced">Experte</option>
                            </select>
                        </div>
                    </div>

                    <!-- Guide Cards -->
                    <div class="row" id="guides-grid">
                        <!-- Static Procurement Tutorial Card -->
                        <div class="col-lg-6 col-xl-4 mb-4 guide-card">
                            <div class="card h-100 border-2 d-flex flex-column" style="border-color: #007bff !important;">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-shopping-cart me-2"></i>Einkauf: Komponenten bestellen
                                        </h5>
                                        <span class="badge bg-info">Interaktiv</span>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column flex-grow-1">
                                    <p class="card-text flex-grow-1">Lernen Sie Schritt f√ºr Schritt, wie Sie Komponenten von Lieferanten bestellen. Dieser interaktive Guide f√ºhrt Sie durch den gesamten Bestellprozess.</p>

                                    <div class="guide-stats mb-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">Schritte</small>
                                                <div class="fw-bold">9</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Dauer</small>
                                                <div class="fw-bold">~5 Min</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Level</small>
                                                <div class="fw-bold">Anf√§nger</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <small class="text-primary">
                                            <i class="fas fa-folder me-1"></i>Einkauf
                                        </small>
                                    </div>

                                    <div class="mb-3">
                                        <span class="badge bg-success">
                                            <i class="fas fa-star me-1"></i>Empfohlen f√ºr Einsteiger
                                        </span>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent mt-auto">
                                    <div class="d-grid">
                                        <button class="btn btn-success" onclick="window.startProcurementTutorial(); return false;">
                                            <i class="fas fa-play me-2"></i>Tutorial starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Static Production Tutorial Card -->
                        <div class="col-lg-6 col-xl-4 mb-4 guide-card">
                            <div class="card h-100 border-2 d-flex flex-column" style="border-color: #ffc107 !important;">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-cogs me-2"></i>Produktion: Fahrr√§der herstellen
                                        </h5>
                                        <span class="badge bg-info">Interaktiv</span>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column flex-grow-1">
                                    <p class="card-text flex-grow-1">Lernen Sie, wie Sie aus Komponenten fertige Fahrr√§der produzieren. Dieser Guide erkl√§rt Ihnen die Produktionsplanung und Kapazit√§tsauslastung.</p>

                                    <div class="guide-stats mb-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">Schritte</small>
                                                <div class="fw-bold">15</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Dauer</small>
                                                <div class="fw-bold">~7 Min</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Level</small>
                                                <div class="fw-bold">Anf√§nger</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <small class="text-warning">
                                            <i class="fas fa-folder me-1"></i>Produktion
                                        </small>
                                    </div>

                                    <div class="mb-3">
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-star me-1"></i>Nach Einkauf empfohlen
                                        </span>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent mt-auto">
                                    <div class="d-grid">
                                        <button class="btn btn-warning" onclick="window.startProductionTutorial(); return false;">
                                            <i class="fas fa-play me-2"></i>Tutorial starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Static Warehouse Tutorial Card -->
                        <div class="col-lg-6 col-xl-4 mb-4 guide-card">
                            <div class="card h-100 border-2 d-flex flex-column" style="border-color: #17a2b8 !important;">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-warehouse me-2"></i>Lager: Bestand verwalten
                                        </h5>
                                        <span class="badge bg-info">Interaktiv</span>
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column flex-grow-1">
                                    <p class="card-text flex-grow-1">Lernen Sie, wie Sie Ihren Lagerbestand √ºberwachen und verwalten. Dieser Guide erkl√§rt Ihnen Lagerkapazit√§ten, gelagerte Komponenten und Fahrr√§der.</p>

                                    <div class="guide-stats mb-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">Schritte</small>
                                                <div class="fw-bold">14</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Dauer</small>
                                                <div class="fw-bold">~6 Min</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Level</small>
                                                <div class="fw-bold">Anf√§nger</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <small class="text-info">
                                            <i class="fas fa-folder me-1"></i>Lager
                                        </small>
                                    </div>

                                    <div class="mb-3">
                                        <span class="badge bg-info">
                                            <i class="fas fa-star me-1"></i>Jederzeit verf√ºgbar
                                        </span>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent mt-auto">
                                    <div class="d-grid">
                                        <button class="btn btn-info" onclick="window.startWarehouseTutorial(); return false;">
                                            <i class="fas fa-play me-2"></i>Tutorial starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% for guide in guides %}
                        <div class="col-lg-6 col-xl-4 mb-4 guide-card" 
                             data-category="{{ guide.category.id }}" 
                             data-type="{{ guide.guide_type }}"
                             data-difficulty="{{ guide.user_level_required }}">
                            <div class="card h-100 border-2 d-flex flex-column">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-0">{{ guide.title }}</h5>
                                        {% if guide.guide_type == 'onboarding' %}
                                        <span class="badge bg-primary">
                                            {{ guide.get_guide_type_display }}
                                        </span>
                                        {% elif guide.guide_type == 'walkthrough' %}
                                        <span class="badge bg-info">
                                            {{ guide.get_guide_type_display }}
                                        </span>
                                        {% elif guide.guide_type == 'feature_intro' %}
                                        <span class="badge bg-success">
                                            {{ guide.get_guide_type_display }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-warning">
                                            {{ guide.get_guide_type_display }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body d-flex flex-column flex-grow-1">
                                    <p class="card-text flex-grow-1">{{ guide.description }}</p>
                                    
                                    <div class="guide-stats mb-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <small class="text-muted">Schritte</small>
                                                <div class="fw-bold">{{ guide.steps|length }}</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Starts</small>
                                                <div class="fw-bold">{{ guide.start_count }}</div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Erfolgsrate</small>
                                                <div class="fw-bold">{{ guide.completion_rate|floatformat:0 }}%</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-primary">
                                            <i class="fas fa-folder me-1"></i>{{ guide.category.name }}
                                        </small>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-signal me-1"></i>{{ guide.get_user_level_required_display }}
                                        </small>
                                    </div>
                                    
                                    {% if guide.target_url_pattern %}
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i class="fas fa-link me-1"></i>Verf√ºgbar auf: {{ guide.target_url_pattern }}
                                        </small>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- User Progress -->
                                    {% if user.is_authenticated %}
                                    <div class="mb-3">
                                        {% if guide in user_progress.guides_completed.all %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Abgeschlossen
                                        </span>
                                        {% elif guide in user_progress.guides_started.all %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-play me-1"></i>Begonnen
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer bg-transparent mt-auto">
                                    <div class="d-grid">
                                        <button class="btn btn-success guide-start-btn"
                                                data-guide-id="{{ guide.id }}"
                                                onclick="if(window.startGuide){window.startGuide({{ guide.id }})}else{alert('Guide system not loaded. Please refresh the page.');}return false;">
                                            <i class="fas fa-play me-2"></i>Guide starten
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-route fa-3x mb-3"></i>
                                <h5>Keine Guides verf√ºgbar</h5>
                                <p>Momentan sind keine interaktiven Guides verf√ºgbar. F√ºge Inhalte √ºber das Admin-Panel hinzu.</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Emergency inline script to verify guide system loads -->
<script>
(function() {
    console.log('üìå Emergency inline script executing...');
    console.log('üìå Checking if window.startGuide exists:', typeof window.startGuide);

    // Set a flag that we can check later
    window.guideSystemCheckpoint = {
        inlineScriptRan: true,
        timestamp: Date.now()
    };

    console.log('üìå Emergency checkpoint set');
})();
</script>

<!-- Guide Preview Modal -->
<div class="modal fade" id="guidePreviewModal" tabindex="-1" aria-labelledby="guidePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guidePreviewModalLabel">Guide Vorschau</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="guide-preview-content">
                    <!-- Guide preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                <button type="button" class="btn btn-success" id="start-guide-btn">
                    <i class="fas fa-play me-2"></i>Guide starten
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block scripts %}
<!-- help-system.js is already loaded in base.html, don't load it again -->
<script>
console.log('üéØ Interactive guides script loading...');

// Helper function to get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Define the startGuide function globally BEFORE DOMContentLoaded
window.startGuide = async function(guideId) {
    console.log('üöÄ ========================================');
    console.log('üöÄ STARTING INTERACTIVE GUIDE');
    console.log('üöÄ Guide ID:', guideId);
    console.log('üöÄ typeof guideId:', typeof guideId);
    console.log('üöÄ ========================================');

    // Validate guide ID
    if (!guideId || (typeof guideId !== 'number' && typeof guideId !== 'string')) {
        console.error('‚ùå Invalid guide ID:', guideId);
        alert('Fehler: Ung√ºltige Anleitungs-ID. Bitte versuchen Sie es erneut.');
        return;
    }

    // Prevent any form submissions or navigation during this process
    console.log('üîí Preventing navigation during guide load...');

    // Show loading message
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'guide-loading';
    loadingDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        min-width: 300px;
    `;
    loadingDiv.innerHTML = `
        <div style="margin-bottom: 15px;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Guide wird geladen...</div>
        <div style="font-size: 12px; color: #666;">Bitte warten Sie einen Moment</div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    document.body.appendChild(loadingDiv);

    try {
        // Get CSRF token
        let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        }
        if (!csrfToken) {
            csrfToken = getCookie('csrftoken');
        }
        if (!csrfToken) {
            throw new Error('CSRF token not found - please reload the page');
        }

        const guideUrl = `/help/api/guides/${guideId}/start/`;
        console.log('üì° Fetching guide data from:', guideUrl);
        console.log('üì° Using CSRF token:', csrfToken ? 'Yes' : 'No');

        let response;
        try {
            response = await fetch(guideUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            });

            console.log('üìä Response received!');
            console.log('üìä Response status:', response.status);
            console.log('üìä Response ok:', response.ok);
        } catch (fetchError) {
            console.error('‚ùå Fetch failed:', fetchError);
            console.error('‚ùå Fetch error name:', fetchError.name);
            console.error('‚ùå Fetch error type:', typeof fetchError);
            console.error('‚ùå Full fetch error:', fetchError);

            // Check if it's an abort error
            if (fetchError.name === 'AbortError' || fetchError.name === 'NS_ERROR_ABORT' ||
                (fetchError.message && fetchError.message.includes('abort'))) {
                throw new Error(`Die Anfrage wurde abgebrochen.\n\nM√∂glicherweise gibt es ein Netzwerkproblem oder die Seite wurde geschlossen.\n\nBitte versuchen Sie es erneut.`);
            }

            throw new Error(`Netzwerkfehler beim Laden der Anleitung: ${fetchError.message || fetchError.name || 'Unbekannter Fehler'}`);
        }

        if (!response.ok) {
            console.error('‚ùå Response not OK!');
            if (response.status === 401) {
                const errorData = await response.json().catch(() => ({ error: 'Authentication required' }));
                throw new Error(`Sie m√ºssen sich anmelden, um die Anleitungen zu verwenden.\n\nFehler: ${errorData.message || errorData.error}`);
            }
            const errorText = await response.text();
            console.error('‚ùå HTTP Error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}\nResponse: ${errorText}`);
        }

        console.log('‚úÖ Response OK, parsing JSON...');
        const data = await response.json();
        console.log('üìã Guide data received:', data);
        console.log('üìã Guide data.success:', data.success);
        console.log('üìã Guide data.guide:', data.guide ? 'exists' : 'missing');

        if (data.success && data.guide) {
            // Get user's active session ID
            console.log('üîç Fetching active sessions from: /api/sessions/');

            let sessionsResponse;
            try {
                sessionsResponse = await fetch('/api/sessions/', {
                    headers: {
                        'X-CSRFToken': csrfToken,
                    }
                });

                console.log('üìä Sessions response status:', sessionsResponse.status);
                console.log('üìä Sessions response ok:', sessionsResponse.ok);
            } catch (fetchError) {
                console.error('‚ùå Sessions fetch failed:', fetchError);
                console.error('‚ùå Sessions error name:', fetchError.name);
                console.error('‚ùå Sessions error type:', typeof fetchError);
                console.error('‚ùå Full sessions error:', fetchError);

                // Check if it's an abort error
                if (fetchError.name === 'AbortError' || fetchError.name === 'NS_ERROR_ABORT' ||
                    (fetchError.message && fetchError.message.includes('abort'))) {
                    throw new Error(`Die Sitzungsabfrage wurde abgebrochen.\n\nBitte versuchen Sie es erneut.`);
                }

                throw new Error(`Netzwerkfehler beim Laden der Sitzungsdaten: ${fetchError.message || fetchError.name || 'Unbekannter Fehler'}`);
            }

            let targetUrl = '';
            if (sessionsResponse.ok) {
                const sessionsData = await sessionsResponse.json();
                console.log('üìä Sessions data:', sessionsData);

                if (sessionsData.success && sessionsData.sessions && sessionsData.sessions.length > 0) {
                    // Use the first session
                    const sessionId = sessionsData.sessions[0].id;
                    targetUrl = `/procurement/${sessionId}/`;
                    console.log('‚úÖ Target URL:', targetUrl);
                } else {
                    throw new Error('Sie haben keine aktive Simulation.\n\nBitte erstellen Sie zun√§chst eine Sitzung unter "Neue Simulation".');
                }
            } else {
                throw new Error('Konnte Sitzungsinformationen nicht laden.\n\nBitte versuchen Sie es sp√§ter erneut.');
            }

            // Store guide data in sessionStorage to load it on the procurement page
            sessionStorage.setItem('pendingGuide', JSON.stringify({
                guideId: guideId,
                guideData: data.guide,
                timestamp: Date.now()
            }));

            console.log('üíæ Guide data stored in sessionStorage');

            // Remove loading message
            loadingDiv.remove();

            // Open procurement page in popup window
            console.log('ü™ü Opening popup window:', targetUrl);
            const popupFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,location=no,menubar=no,status=yes';
            const popup = window.open(targetUrl, 'BikeShopGuide_' + guideId, popupFeatures);

            if (!popup) {
                throw new Error('Pop-up wurde blockiert.\n\nBitte erlauben Sie Pop-ups f√ºr diese Seite und versuchen Sie es erneut.');
            }

            // Check if popup was opened successfully
            try {
                popup.focus();
                console.log('‚úÖ Popup window opened and focused successfully');
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not focus popup window:', e);
            }

            // Monitor popup to detect if it was closed prematurely
            const popupCheckInterval = setInterval(() => {
                if (popup.closed) {
                    console.log('üö™ Popup window was closed');
                    clearInterval(popupCheckInterval);
                    sessionStorage.removeItem('pendingGuide');
                }
            }, 1000);

            // The popup will automatically check sessionStorage and start the guide
            console.log('‚úÖ Guide setup complete, waiting for popup to load...');

        } else {
            throw new Error('Anleitung nicht gefunden oder ung√ºltig');
        }

    } catch (error) {
        console.error('‚ùå Error starting guide:', error);
        console.error('‚ùå Error name:', error.name);
        console.error('‚ùå Error message:', error.message);
        console.error('‚ùå Error stack:', error.stack);

        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.remove();
        }

        // Show error message with more details
        let errorMessage = error.message || error.toString() || 'Unknown error';
        if (error.name) {
            errorMessage = `${error.name}: ${errorMessage}`;
        }

        alert(`‚ùå Die Anleitung konnte nicht geladen werden.\n\nFehler: ${errorMessage}\n\nBitte √ºberpr√ºfen Sie die Browser-Konsole f√ºr weitere Details.`);
    }
};

console.log('‚úÖ window.startGuide function defined:', typeof window.startGuide);

// NOW setup the DOMContentLoaded listener
document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to continue a guide from another page
    const continueGuideData = sessionStorage.getItem('continueGuide');
    if (continueGuideData) {
        try {
            const guideInfo = JSON.parse(continueGuideData);
            sessionStorage.removeItem('continueGuide'); // Clean up
            
            console.log('üîÑ Continuing guide from navigation:', guideInfo);
            
            // Small delay to let page settle
            setTimeout(() => {
                createInteractiveGuide(guideInfo.guide, guideInfo.stepIndex);
            }, 1000);
            
            return; // Skip normal page initialization
        } catch (error) {
            console.error('Error continuing guide:', error);
            sessionStorage.removeItem('continueGuide');
        }
    }
    
    const categoryFilter = document.getElementById('category-filter');
    const typeFilter = document.getElementById('type-filter');
    const difficultyFilter = document.getElementById('difficulty-filter');
    const guideCards = document.querySelectorAll('.guide-card');
    
    // Filter functionality
    function applyFilters() {
        const category = categoryFilter.value;
        const type = typeFilter.value;
        const difficulty = difficultyFilter.value;
        
        guideCards.forEach(card => {
            let show = true;
            
            if (category && card.dataset.category !== category) {
                show = false;
            }
            
            if (type && card.dataset.type !== type) {
                show = false;
            }
            
            if (difficulty && card.dataset.difficulty !== difficulty) {
                show = false;
            }
            
            card.style.display = show ? 'block' : 'none';
        });
    }
    
    // Event listeners
    categoryFilter.addEventListener('change', applyFilters);
    typeFilter.addEventListener('change', applyFilters);
    difficultyFilter.addEventListener('change', applyFilters);

    // Add event listeners to all guide start buttons
    // NOTE: Event listeners are DISABLED because we're using onclick handlers in HTML
    // This prevents double-firing of the startGuide function
    const guideStartButtons = document.querySelectorAll('.guide-start-btn');
    console.log('‚úÖ Found guide start buttons:', guideStartButtons.length);

    guideStartButtons.forEach((button, index) => {
        console.log(`  Button ${index + 1}:`, {
            id: button.getAttribute('data-guide-id'),
            text: button.textContent.trim(),
            hasOnclick: button.hasAttribute('onclick')
        });
    });

    console.log('‚ÑπÔ∏è Using inline onclick handlers (not event listeners) to prevent double-firing');

    console.log('‚úÖ Interactive guides page loaded');
    console.log('‚úÖ window.startGuide defined:', typeof window.startGuide);

    // Store current guide ID for modal
    window.currentGuideId = null;

    // Start guide button in modal
    const modalStartBtn = document.getElementById('start-guide-btn');
    if (modalStartBtn) {
        modalStartBtn.addEventListener('click', function() {
            if (window.currentGuideId && window.helpSystem) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('guidePreviewModal'));
                modal.hide();
                window.helpSystem.startGuide(window.currentGuideId);
            }
        });
    }
});

function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

async function createInteractiveGuide(guide, startStep = 0, isPopup = false) {
    console.log('üé¨ Creating interactive guide:', guide.title, 'starting at step', startStep, 'isPopup:', isPopup);
    
    // Create grey overlay that covers entire page
    const overlay = document.createElement('div');
    overlay.id = 'guide-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        pointer-events: none;
    `;
    document.body.appendChild(overlay);
    
    // Create guide container
    const guideContainer = document.createElement('div');
    guideContainer.id = 'guide-container';
    guideContainer.style.cssText = `
        position: absolute;
        width: 350px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        z-index: 10001;
        font-family: Arial, sans-serif;
        pointer-events: auto;
    `;
    document.body.appendChild(guideContainer);
    
    let currentStep = startStep;
    let currentHighlight = null;
    let currentTargetElement = null;
    let currentPlacement = 'right';

    const expandElementIfNeeded = async (targetElement) => {
        // Check if element is inside a dropdown menu
        const dropdownMenu = targetElement.closest('.dropdown-menu');
        if (dropdownMenu) {
            // Find the dropdown toggle button
            const dropdown = dropdownMenu.previousElementSibling;
            if (dropdown && dropdown.classList.contains('dropdown-toggle')) {
                // Check if dropdown is not already shown
                if (!dropdownMenu.classList.contains('show')) {
                    console.log('Opening dropdown for:', targetElement);
                    dropdown.click();
                    // Wait for dropdown animation
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
        }

        // Check if element is a dropdown toggle itself
        if (targetElement.classList.contains('dropdown-toggle') ||
            targetElement.hasAttribute('data-bs-toggle')) {
            const nextElement = targetElement.nextElementSibling;
            if (nextElement && nextElement.classList.contains('dropdown-menu') &&
                !nextElement.classList.contains('show')) {
                console.log('Opening dropdown toggle:', targetElement);
                targetElement.click();
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }

        // Check if element is inside a collapse
        const collapseParent = targetElement.closest('.collapse');
        if (collapseParent && !collapseParent.classList.contains('show')) {
            // Find the button that controls this collapse
            const collapseId = collapseParent.id;
            if (collapseId) {
                const collapseToggle = document.querySelector(`[data-bs-toggle="collapse"][data-bs-target="#${collapseId}"]`);
                if (collapseToggle) {
                    console.log('Expanding collapse for:', targetElement);
                    collapseToggle.click();
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
        }

        // Check if element has display: none or visibility: hidden
        const styles = window.getComputedStyle(targetElement);
        if (styles.display === 'none' || styles.visibility === 'hidden') {
            console.log('Element is hidden, checking for show/hide mechanisms');

            // Try to find parent with display:none
            let parent = targetElement.parentElement;
            while (parent && parent !== document.body) {
                const parentStyles = window.getComputedStyle(parent);
                if (parentStyles.display === 'none') {
                    // Try to show the parent
                    parent.style.display = 'block';
                    await new Promise(resolve => setTimeout(resolve, 100));
                    break;
                }
                parent = parent.parentElement;
            }
        }

        // Extra wait to ensure everything is rendered
        await new Promise(resolve => setTimeout(resolve, 100));
    };

    const positionGuideContainer = async (targetElement, placement = 'right') => {
        if (!targetElement) {
            // Default position if no target element
            guideContainer.style.top = '20px';
            guideContainer.style.right = '20px';
            guideContainer.style.left = 'auto';
            guideContainer.style.bottom = 'auto';
            return Promise.resolve();
        }

        // Scroll element into view and wait
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        // Wait for scroll animation and layout to settle
        await new Promise(resolve => setTimeout(resolve, 400));

        const rect = targetElement.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        const containerWidth = 350;
        const containerHeight = guideContainer.offsetHeight || 300;
        const margin = 20;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        let top, left;
        let finalPlacement = placement;

        // Calculate initial position based on placement
        switch (placement) {
            case 'top':
                top = rect.top + scrollTop - containerHeight - margin;
                left = rect.left + scrollLeft + (rect.width / 2) - (containerWidth / 2);
                break;
            case 'bottom':
                top = rect.bottom + scrollTop + margin;
                left = rect.left + scrollLeft + (rect.width / 2) - (containerWidth / 2);
                break;
            case 'left':
                top = rect.top + scrollTop + (rect.height / 2) - (containerHeight / 2);
                left = rect.left + scrollLeft - containerWidth - margin;
                break;
            case 'right':
            default:
                top = rect.top + scrollTop + (rect.height / 2) - (containerHeight / 2);
                left = rect.right + scrollLeft + margin;
                break;
        }

        // Adjust if going off-screen horizontally
        if (left + containerWidth > scrollLeft + viewportWidth - margin) {
            // Try left side instead
            left = rect.left + scrollLeft - containerWidth - margin;
            finalPlacement = 'left';
        }
        if (left < scrollLeft + margin) {
            // Try right side
            left = rect.right + scrollLeft + margin;
            finalPlacement = 'right';
            // If still off, center below
            if (left + containerWidth > scrollLeft + viewportWidth - margin) {
                left = Math.max(scrollLeft + margin, (viewportWidth - containerWidth) / 2 + scrollLeft);
                top = rect.bottom + scrollTop + margin;
                finalPlacement = 'bottom';
            }
        }

        // Adjust if going off-screen vertically
        if (top < scrollTop + margin) {
            top = rect.bottom + scrollTop + margin;
            finalPlacement = 'bottom';
        }
        if (top + containerHeight > scrollTop + viewportHeight - margin) {
            top = Math.max(scrollTop + margin, scrollTop + viewportHeight - containerHeight - margin);
        }

        // Apply positioning
        guideContainer.style.position = 'absolute';
        guideContainer.style.top = top + 'px';
        guideContainer.style.left = left + 'px';
        guideContainer.style.right = 'auto';
        guideContainer.style.bottom = 'auto';
        guideContainer.style.transform = 'none';

        // Add arrow
        addPointerArrow(finalPlacement);

        // Ensure guide box is visible - scroll if needed
        await new Promise(resolve => setTimeout(resolve, 50));
        const containerRect = guideContainer.getBoundingClientRect();
        // viewportHeight and viewportWidth already declared above

        // Check if guide box extends beyond viewport
        if (containerRect.bottom > viewportHeight || containerRect.top < 0 ||
            containerRect.right > viewportWidth || containerRect.left < 0) {
            // Scroll to make guide box visible
            const scrollTargetY = top - 100; // Add some padding
            const scrollTargetX = left - 20;
            window.scrollTo({
                top: Math.max(0, scrollTargetY),
                left: Math.max(0, scrollTargetX),
                behavior: 'smooth'
            });
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        return Promise.resolve();
    };
    
    const addPointerArrow = (placement) => {
        // Remove existing arrow
        const existingArrow = guideContainer.querySelector('.guide-arrow');
        if (existingArrow) {
            existingArrow.remove();
        }
        
        // Create new arrow
        const arrow = document.createElement('div');
        arrow.className = 'guide-arrow';
        
        const arrowSize = 12;
        let arrowStyles = `
            position: absolute;
            width: 0;
            height: 0;
            z-index: 10002;
        `;
        
        switch (placement) {
            case 'top':
                arrowStyles += `
                    bottom: -${arrowSize}px;
                    left: 50%;
                    transform: translateX(-50%);
                    border-left: ${arrowSize}px solid transparent;
                    border-right: ${arrowSize}px solid transparent;
                    border-top: ${arrowSize}px solid white;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                `;
                break;
            case 'bottom':
                arrowStyles += `
                    top: -${arrowSize}px;
                    left: 50%;
                    transform: translateX(-50%);
                    border-left: ${arrowSize}px solid transparent;
                    border-right: ${arrowSize}px solid transparent;
                    border-bottom: ${arrowSize}px solid white;
                    filter: drop-shadow(0 -2px 4px rgba(0,0,0,0.1));
                `;
                break;
            case 'left':
                arrowStyles += `
                    right: -${arrowSize}px;
                    top: 50%;
                    transform: translateY(-50%);
                    border-top: ${arrowSize}px solid transparent;
                    border-bottom: ${arrowSize}px solid transparent;
                    border-left: ${arrowSize}px solid white;
                    filter: drop-shadow(2px 0 4px rgba(0,0,0,0.1));
                `;
                break;
            case 'right':
            default:
                arrowStyles += `
                    left: -${arrowSize}px;
                    top: 50%;
                    transform: translateY(-50%);
                    border-top: ${arrowSize}px solid transparent;
                    border-bottom: ${arrowSize}px solid transparent;
                    border-right: ${arrowSize}px solid white;
                    filter: drop-shadow(-2px 0 4px rgba(0,0,0,0.1));
                `;
                break;
        }
        
        arrow.style.cssText = arrowStyles;
        guideContainer.appendChild(arrow);
    };
    
    const showStep = async (stepIndex) => {
        if (stepIndex >= guide.steps.length) {
            // Guide completed
            endGuide();
            if (isPopup) {
                alert('üéâ Anleitung erfolgreich abgeschlossen!\\n\\nSie haben alle Schritte durchlaufen. Das Fenster wird nun geschlossen.');
                // Close the popup window
                if (window.guideWindow) {
                    window.guideWindow.close();
                } else {
                    window.close();
                }
            } else {
                alert('üéâ Anleitung erfolgreich abgeschlossen!\\n\\nSie haben alle Schritte durchlaufen. Viel Erfolg bei der Simulation!');
            }
            return;
        }
        
        const step = guide.steps[stepIndex];
        console.log(`üìç Showing step ${stepIndex + 1}: ${step.title}`);
        
        // Remove previous highlight
        if (currentHighlight) {
            currentHighlight.remove();
        }
        
        // Navigate to target page if specified
        if (step.navigate_to) {
            console.log(`üß≠ Navigating to: ${step.navigate_to}`);
            
            // Replace {{ session_id }} with actual session ID from current URL
            let navigationUrl = step.navigate_to;
            const currentUrl = window.location.pathname;
            const sessionIdMatch = currentUrl.match(/([a-f0-9-]{36})/);
            
            if (sessionIdMatch && navigationUrl.includes('{{ session_id }}')) {
                navigationUrl = navigationUrl.replace('{{ session_id }}', sessionIdMatch[1]);
                console.log(`üîÑ Replaced session ID: ${navigationUrl}`);
            }
            
            // Store guide continuation data
            sessionStorage.setItem('continueGuide', JSON.stringify({
                guideId: guide.id,
                stepIndex: stepIndex + 1,
                guide: guide
            }));
            
            window.location.href = navigationUrl;
            return; // Let the page load and continue guide there
        }
        
        // Update guide container content FIRST
        const isLastStep = stepIndex === guide.steps.length - 1;
        const progress = Math.round(((stepIndex + 1) / guide.steps.length) * 100);

        guideContainer.innerHTML = `
            <div style="padding: 20px;">
                <!-- Progress bar -->
                <div style="margin-bottom: 15px;">
                    <div style="background: #f0f0f0; height: 4px; border-radius: 2px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${progress}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: #666; margin-top: 5px;">
                        Schritt ${stepIndex + 1} von ${guide.steps.length}
                    </div>
                </div>
                
                <!-- Guide content -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333; font-size: 18px;">
                        ${step.title}
                    </h4>
                    <p style="margin: 0; color: #555; line-height: 1.5; font-size: 14px;">
                        ${step.content}
                    </p>
                </div>
                
                <!-- Buttons -->
                <div style="display: flex; gap: 8px;">
                    ${stepIndex > 0 ? `
                        <button onclick="window.previousStep()" style="flex: 1; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ‚Üê Zur√ºck
                        </button>
                    ` : ''}
                    <button onclick="window.nextStep()" style="flex: 2; padding: 8px 16px; background: ${isLastStep ? '#28a745' : '#007bff'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                        ${isLastStep ? 'üéâ Fertig' : 'Weiter ‚Üí'}
                    </button>
                    <button onclick="window.endGuide()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ‚úï
                    </button>
                </div>
            </div>
        `;

        // NOW position the guide container after content is set
        let targetElement = null;
        if (step.target && step.target !== 'body') {
            targetElement = document.querySelector(step.target);
            if (targetElement) {
                currentTargetElement = targetElement;
                currentPlacement = step.placement || 'right';

                // Auto-expand elements if needed
                await expandElementIfNeeded(targetElement);

                // Wait for positioning to complete
                await positionGuideContainer(targetElement, currentPlacement);

                // Then add highlight
                highlightElement(targetElement);
            } else {
                console.warn(`‚ö†Ô∏è Target element not found: ${step.target}`);
                currentTargetElement = null;
                // Use default positioning if target not found
                await positionGuideContainer(null);
            }
        } else {
            // Center the guide for body/general steps
            currentTargetElement = null;
            guideContainer.style.position = 'fixed';
            guideContainer.style.top = '50%';
            guideContainer.style.left = '50%';
            guideContainer.style.transform = 'translate(-50%, -50%)';
            guideContainer.style.right = 'auto';
            guideContainer.style.bottom = 'auto';

            // Remove arrow for centered guides
            const existingArrow = guideContainer.querySelector('.guide-arrow');
            if (existingArrow) {
                existingArrow.remove();
            }
        }
    };
    
    const highlightElement = (element) => {
        const rect = element.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

        // Create highlight box
        currentHighlight = document.createElement('div');
        currentHighlight.style.cssText = `
            position: absolute;
            top: ${rect.top + scrollTop - 5}px;
            left: ${rect.left + scrollLeft - 5}px;
            width: ${rect.width + 10}px;
            height: ${rect.height + 10}px;
            border: 3px solid #007bff;
            border-radius: 8px;
            background: transparent;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
            animation: guidePulse 2s infinite;
        `;

        // Add pulsing animation
        if (!document.getElementById('guide-animations')) {
            const style = document.createElement('style');
            style.id = 'guide-animations';
            style.textContent = `
                @keyframes guidePulse {
                    0% { box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); }
                    50% { box-shadow: 0 0 30px rgba(0, 123, 255, 0.8); }
                    100% { box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); }
                }
            `;
            document.head.appendChild(style);
        }

        document.body.appendChild(currentHighlight);
    };
    
    // Global functions for buttons
    window.nextStep = () => {
        console.log('Next step clicked, current:', currentStep);
        currentStep++;
        showStep(currentStep);
    };
    
    window.previousStep = () => {
        console.log('Previous step clicked, current:', currentStep);
        currentStep--;
        showStep(currentStep);
    };
    
    window.endGuide = () => {
        console.log('üèÅ Ending guide');
        if (overlay) overlay.remove();
        if (guideContainer) guideContainer.remove();
        if (currentHighlight) currentHighlight.remove();

        // Remove resize listener
        window.removeEventListener('resize', repositionGuide);
        window.removeEventListener('scroll', repositionGuide);

        // Clean up global functions
        delete window.nextStep;
        delete window.previousStep;
        delete window.endGuide;
        delete window.repositionGuide;

        // Close popup if this is in a popup window
        if (isPopup) {
            if (window.guideWindow) {
                window.guideWindow.close();
            } else {
                window.close();
            }
        }
    };
    
    // Reposition guide when window resizes or scrolls
    window.repositionGuide = () => {
        if (currentTargetElement) {
            positionGuideContainer(currentTargetElement, currentPlacement);
            // Also update highlight position
            if (currentHighlight) {
                currentHighlight.remove();
                highlightElement(currentTargetElement);
            }
        }
    };
    
    // Add event listeners for repositioning
    window.addEventListener('resize', window.repositionGuide);
    window.addEventListener('scroll', window.repositionGuide);
    
    // Start with first step
    showStep(0);
}


function extractViewFromUrl(url) {
    // Extract view type from URL patterns like '/procurement/...' -> 'procurement'
    const patterns = {
        'procurement': 'procurement',
        'production': 'production', 
        'sales': 'sales',
        'finance': 'finance',
        'warehouse': 'warehouse'
    };
    
    for (const [key, value] of Object.entries(patterns)) {
        if (url.includes(key)) {
            return value;
        }
    }
    return 'overview';
}

async function createFallbackGuide(guideId) {
    console.log('Using fallback guide system');
    
    try {
        // Get guide data without starting
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        const response = await fetch(`/help/api/guides/${guideId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const guide = data.guide;
            let currentStep = 0;
            
            function showStep() {
                if (currentStep >= guide.steps.length) {
                    alert('Anleitung abgeschlossen! üéâ');
                    return;
                }
                
                const step = guide.steps[currentStep];
                const stepText = `${guide.title}\n\nSchritt ${currentStep + 1} von ${guide.steps.length}\n\n${step.title}\n\n${step.content}\n\nWeiter?`;
                
                if (confirm(stepText)) {
                    currentStep++;
                    showStep();
                }
            }
            
            showStep();
        }
    } catch (error) {
        console.error('Fallback guide failed:', error);
        alert('Die Anleitung konnte leider nicht geladen werden.');
    }
}


function previewGuide(guideId) {
    // Store guide ID for later use
    window.currentGuideId = guideId;

    // Fetch guide details
    fetch(`/help/api/guides/${guideId}/preview/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('guide-preview-content');
            content.innerHTML = `
                <div class="mb-3">
                    <h6>${data.title}</h6>
                    <p>${data.description}</p>
                </div>
                <div class="mb-3">
                    <h6>Schritte:</h6>
                    <div class="list-group">
                        ${data.steps.map((step, index) => `
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Schritt ${index + 1}: ${step.title || 'Ohne Titel'}</h6>
                                    <small>${step.target || 'Allgemein'}</small>
                                </div>
                                <p class="mb-1">${step.content || 'Keine Beschreibung'}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Dieser Guide f√ºhrt dich interaktiv durch die Anwendung.
                    Folge den Anweisungen und klicke auf die hervorgehobenen Elemente.
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('guidePreviewModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching guide preview:', error);
            // Fallback: just start the guide
            startGuide(guideId);
        });
}

// Final verification that everything is loaded
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
console.log('üéâ INTERACTIVE GUIDES SCRIPT FULLY LOADED!');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
console.log('‚úÖ window.startGuide available:', typeof window.startGuide === 'function');
console.log('‚úÖ Emergency checkpoint:', window.guideSystemCheckpoint);
console.log('‚úÖ Ready to handle guide button clicks');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

// Add a test function to verify from console
window.testGuideSystem = function() {
    console.log('=== GUIDE SYSTEM TEST ===');
    console.log('window.startGuide exists:', typeof window.startGuide);
    console.log('Emergency checkpoint:', window.guideSystemCheckpoint);
    console.log('Attempting to call with test ID 1...');
    if (typeof window.startGuide === 'function') {
        console.log('Function exists, calling it...');
        // Don't actually call it in test, just verify it exists
        console.log('‚úÖ Function is callable. Use window.startGuide(ID) to test with a real guide ID');
    } else {
        console.log('‚ùå Function does not exist!');
        console.log('Available window properties:', Object.keys(window).filter(k => k.includes('guide') || k.includes('Guide')));
    }
    console.log('=========================');
};

console.log('üí° TIP: Run window.testGuideSystem() in console to test the guide system');
console.log('üí° TIP: Run window.startGuide(1) to test starting guide with ID 1');
console.log('üí° TIP: If button still shows error, check browser console for JavaScript errors');

// Immediately verify the function is accessible
if (typeof window.startGuide === 'function') {
    console.log('‚úÖ‚úÖ‚úÖ SUCCESS: window.startGuide is ready to use! ‚úÖ‚úÖ‚úÖ');
} else {
    console.error('‚ùå‚ùå‚ùå ERROR: window.startGuide was NOT defined! ‚ùå‚ùå‚ùå');
    console.error('This indicates a JavaScript error occurred during script execution.');
    console.error('Please check for syntax errors above this message.');
}

// Procurement Tutorial Launcher
window.startProcurementTutorial = async function() {
    console.log('üéì Starting Procurement Tutorial...');

    try {
        // Get user's active session
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

        // Fetch active sessions
        const sessionsResponse = await fetch('/api/sessions/', {
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        if (!sessionsResponse.ok) {
            throw new Error('Konnte Sitzungsinformationen nicht laden');
        }

        const sessionsData = await sessionsResponse.json();

        if (!sessionsData.success || !sessionsData.sessions || sessionsData.sessions.length === 0) {
            alert('Sie haben keine aktive Simulation.\n\nBitte erstellen Sie zun√§chst eine Sitzung unter "Neue Simulation".');
            return;
        }

        // Use first session
        const sessionId = sessionsData.sessions[0].id;
        const procurementUrl = `/procurement/${sessionId}/?tutorial=true`;

        console.log('üéØ Opening procurement page with tutorial mode:', procurementUrl);

        // Open in new window
        const windowFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,location=no,menubar=no,status=yes';
        const tutorialWindow = window.open(procurementUrl, 'ProcurementTutorial', windowFeatures);

        if (!tutorialWindow) {
            alert('Pop-up wurde blockiert.\n\nBitte erlauben Sie Pop-ups f√ºr diese Seite und versuchen Sie es erneut.');
            return;
        }

        tutorialWindow.focus();
        console.log('‚úÖ Tutorial window opened successfully');

    } catch (error) {
        console.error('‚ùå Error starting procurement tutorial:', error);
        alert('Fehler beim Starten des Tutorials:\n\n' + error.message);
    }
};

console.log('‚úÖ window.startProcurementTutorial defined');

// Production Tutorial Launcher
window.startProductionTutorial = async function() {
    console.log('üéì Starting Production Tutorial...');

    try {
        // Get user's active session
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

        // Fetch active sessions
        const sessionsResponse = await fetch('/api/sessions/', {
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        if (!sessionsResponse.ok) {
            throw new Error('Konnte Sitzungsinformationen nicht laden');
        }

        const sessionsData = await sessionsResponse.json();

        if (!sessionsData.success || !sessionsData.sessions || sessionsData.sessions.length === 0) {
            alert('Sie haben keine aktive Simulation.\n\nBitte erstellen Sie zun√§chst eine Sitzung unter "Neue Simulation".');
            return;
        }

        // Use first session
        const sessionId = sessionsData.sessions[0].id;
        const productionUrl = `/production/${sessionId}/?tutorial=true`;

        console.log('üéØ Opening production page with tutorial mode:', productionUrl);

        // Open in new window
        const windowFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,location=no,menubar=no,status=yes';
        const tutorialWindow = window.open(productionUrl, 'ProductionTutorial', windowFeatures);

        if (!tutorialWindow) {
            alert('Pop-up wurde blockiert.\n\nBitte erlauben Sie Pop-ups f√ºr diese Seite und versuchen Sie es erneut.');
            return;
        }

        tutorialWindow.focus();
        console.log('‚úÖ Tutorial window opened successfully');

    } catch (error) {
        console.error('‚ùå Error starting production tutorial:', error);
        alert('Fehler beim Starten des Tutorials:\n\n' + error.message);
    }
};

console.log('‚úÖ window.startProductionTutorial defined');

// Warehouse Tutorial Launcher
window.startWarehouseTutorial = async function() {
    console.log('üéì Starting Warehouse Tutorial...');

    try {
        // Get user's active session
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

        // Fetch active sessions
        const sessionsResponse = await fetch('/api/sessions/', {
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });

        if (!sessionsResponse.ok) {
            throw new Error('Konnte Sitzungsinformationen nicht laden');
        }

        const sessionsData = await sessionsResponse.json();

        if (!sessionsData.success || !sessionsData.sessions || sessionsData.sessions.length === 0) {
            alert('Sie haben keine aktive Simulation.\n\nBitte erstellen Sie zun√§chst eine Sitzung unter "Neue Simulation".');
            return;
        }

        // Use first session
        const sessionId = sessionsData.sessions[0].id;
        const warehouseUrl = `/warehouse/${sessionId}/?tutorial=true`;

        console.log('üéØ Opening warehouse page with tutorial mode:', warehouseUrl);

        // Open in new window
        const windowFeatures = 'width=1400,height=900,scrollbars=yes,resizable=yes,toolbar=no,location=no,menubar=no,status=yes';
        const tutorialWindow = window.open(warehouseUrl, 'WarehouseTutorial', windowFeatures);

        if (!tutorialWindow) {
            alert('Pop-up wurde blockiert.\n\nBitte erlauben Sie Pop-ups f√ºr diese Seite und versuchen Sie es erneut.');
            return;
        }

        tutorialWindow.focus();
        console.log('‚úÖ Tutorial window opened successfully');

    } catch (error) {
        console.error('‚ùå Error starting warehouse tutorial:', error);
        alert('Fehler beim Starten des Tutorials:\n\n' + error.message);
    }
};

console.log('‚úÖ window.startWarehouseTutorial defined');
</script>
{% endblock %}