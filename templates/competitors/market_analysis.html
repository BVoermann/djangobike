{% extends 'base.html' %}

{% block title %}Marktanalyse{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>Marktanalyse</h1>
                    <p class="text-muted">Monat {{ current_month }}/{{ current_year }}</p>
                </div>
                <div>
                    <a href="{% url 'competitors:dashboard' session.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Zurück
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Marktübersicht -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-area"></i> Wettbewerbssituation nach Märkten</h5>
                </div>
                <div class="card-body">
                    {% if market_data %}
                        {% for market_name, segments in market_data.items %}
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">{{ market_name }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fahrradtyp</th>
                                            <th>Preissegment</th>
                                            <th>Angebot</th>
                                            <th>Nachfrage</th>
                                            <th>Sättigung</th>
                                            <th>Preisdruck</th>
                                            <th>Wettbewerbsintensität</th>
                                            <th>Empfehlung</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for segment in segments %}
                                        <tr>
                                            <td>{{ segment.bike_type }}</td>
                                            <td>
                                                <span class="badge {% if segment.price_segment == 'Günstig' %}bg-success{% elif segment.price_segment == 'Standard' %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ segment.price_segment }}
                                                </span>
                                            </td>
                                            <td>{{ segment.total_supply }}</td>
                                            <td>{{ segment.estimated_demand }}</td>
                                            <td>
                                                <span class="badge {% if segment.saturation_level > 1.2 %}bg-danger{% elif segment.saturation_level > 0.8 %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ segment.saturation_level }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if segment.price_pressure > 0 %}
                                                    <span class="text-success">+{{ segment.price_pressure }}</span>
                                                {% elif segment.price_pressure < 0 %}
                                                    <span class="text-danger">{{ segment.price_pressure }}</span>
                                                {% else %}
                                                    <span class="text-muted">0.0</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge {% if segment.competition_intensity == 'Hoch' %}bg-danger{% elif segment.competition_intensity == 'Mittel' %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ segment.competition_intensity }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if segment.saturation_level < 0.7 %}
                                                    <small class="text-success"><strong>Gute Gelegenheit:</strong> Wenig Konkurrenz</small>
                                                {% elif segment.saturation_level < 1.0 %}
                                                    <small class="text-warning"><strong>Normaler Markt:</strong> Moderate Konkurrenz</small>
                                                {% elif segment.saturation_level < 1.3 %}
                                                    <small class="text-danger"><strong>Übersättigt:</strong> Preiskampf möglich</small>
                                                {% else %}
                                                    <small class="text-danger"><strong>Kritisch:</strong> Markt überfüllt</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Keine Marktdaten verfügbar.</strong><br>
                            Marktdaten werden alle 3 Monate generiert. Warten Sie auf den nächsten Verkaufszyklus.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if market_data %}
    <!-- Strategische Empfehlungen -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb"></i> Strategische Empfehlungen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-chart-line"></i> Wachstumschancen</h6>
                                <p class="small mb-0">
                                    Märkte mit Sättigung unter 70% bieten gute Wachstumschancen 
                                    mit wenig Konkurrenz und stabilen Preisen.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-balance-scale"></i> Ausgewogene Märkte</h6>
                                <p class="small mb-0">
                                    Märkte mit Sättigung 70-100% sind stabil aber umkämpft. 
                                    Qualität und Effizienz sind entscheidend.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> Risikomärkte</h6>
                                <p class="small mb-0">
                                    Märkte über 100% Sättigung führen zu Preiskämpfen. 
                                    Vorsicht bei neuen Investitionen.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Legende:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Sättigung:</strong> Verhältnis von Angebot zu Nachfrage (0.0 = keine Konkurrenz, 1.0+ = Überangebot)</li>
                            <li><strong>Preisdruck:</strong> Positiv = höhere Preise möglich, Negativ = Preise unter Druck</li>
                            <li><strong>Wettbewerbsintensität:</strong> Basiert auf Sättigung und Anzahl der Konkurrenten</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}