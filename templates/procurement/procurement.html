{% extends request.base_template|default:'base.html' %}
{% load math_filters %}
{% load static %}

{% block title %}Einkauf - BikeShop Pro{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-5">
    <div class="col-12">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-shopping-cart" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                Einkauf
            </h1>
            <p class="lead text-muted">Bestellen Sie hochwertige Komponenten von Ihren Lieferanten</p>
        </div>
    </div>
</div>

<!-- Supplier Selection Dropdown -->
{% if supplier_data %}
<div class="row mb-4 dropdown-row supplier-dropdown-row">
    <div class="col-12">
        <div class="card border-0 dropdown-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); overflow: visible;">
            <div class="card-body p-4" style="overflow: visible;">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-filter me-2"></i>Lieferant ausw√§hlen
                </h5>
                <div class="dropdown">
                    <button class="btn btn-primary btn-lg dropdown-toggle w-100 w-md-auto" type="button" id="supplierDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-industry me-2"></i>
                        <span id="selected-supplier-name">Bitte Lieferant ausw√§hlen</span>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="supplierDropdown" style="min-width: 400px;">
                        {% for supplier_id, data in supplier_data.items %}
                        <li>
                            <a class="dropdown-item supplier-option p-3" href="#" data-supplier-id="{{ supplier_id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold mb-2">
                                            <i class="fas fa-industry me-2"></i>{{ data.supplier.name }}
                                        </h6>
                                        <p class="text-muted mb-2 small">
                                            {% if data.supplier.quality == 'basic' %}
                                                <i class="fas fa-star text-warning me-1"></i>G√ºnstige Preise, grundlegende Qualit√§t
                                            {% elif data.supplier.quality == 'standard' %}
                                                <i class="fas fa-star-half-alt text-info me-1"></i>Ausgewogenes Preis-Leistungs-Verh√§ltnis
                                            {% elif data.supplier.quality == 'premium' %}
                                                <i class="fas fa-crown text-success me-1"></i>H√∂chste Qualit√§t, premium Komponenten
                                            {% endif %}
                                        </p>
                                        <div class="supplier-info-badges">
                                            <span class="badge bg-primary me-1" title="Angegebene Lieferzeit (aktuell erfolgt Lieferung sofort)" style="cursor: help;">
                                                <i class="fas fa-truck me-1"></i>{{ data.supplier.delivery_time }}T <small>(sofort)</small>
                                            </span>
                                            <span class="badge bg-success me-1" title="Angegebenes Zahlungsziel (aktuell erfolgt Zahlung sofort)" style="cursor: help;">
                                                <i class="fas fa-calendar me-1"></i>{{ data.supplier.payment_terms }}T Ziel <small>(sofort)</small>
                                            </span>
                                            <span class="badge bg-warning">
                                                <i class="fas fa-exclamation-triangle me-1"></i>{{ data.supplier.complaint_probability|floatformat:1 }}% Rekl.
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bike Type Filter Dropdown -->
<div class="row mb-4 dropdown-row" id="bike-type-filter-row" style="display: none;">
    <div class="col-12">
        <div class="card border-0 dropdown-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); overflow: visible;">
            <div class="card-body p-4" style="overflow: visible;">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-bicycle me-2"></i>Komponenten filtern nach Fahrradtyp
                </h5>
                <div class="dropdown">
                    <button class="btn btn-success btn-lg dropdown-toggle w-100 w-md-auto" type="button" id="bikeTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-filter me-2"></i>
                        <span id="selected-bike-type-name">Alle Komponenten anzeigen</span>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="bikeTypeDropdown" style="min-width: 300px;">
                        <li>
                            <a class="dropdown-item bike-type-option p-3 active" href="#" data-bike-type-id="all">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-list me-3 text-primary"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">Alle Komponenten</h6>
                                        <p class="text-muted mb-0 small">Zeige alle verf√ºgbaren Komponenten des Lieferanten</p>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for bike_type in bike_types %}
                        <li>
                            <a class="dropdown-item bike-type-option p-3" href="#" data-bike-type-id="{{ bike_type.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-bicycle me-3 text-success"></i>
                                    <div>
                                        <h6 class="fw-bold mb-1">{{ bike_type.name }}</h6>
                                        <p class="text-muted mb-0 small">Zeige nur Komponenten f√ºr {{ bike_type.name }}</p>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Einkaufs-Statistiken -->
<div class="row g-4 mb-5" id="stats-row">
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 border-0" style="background: var(--success-gradient); color: white;">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="fas fa-wallet"></i>
                </div>
                <h2 class="fw-bold">{{ session.balance|floatformat:2 }}‚Ç¨</h2>
                <p class="mb-0 opacity-75">Verf√ºgbares Budget</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 border-0" style="background: var(--primary-gradient); color: white;">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="fas fa-truck"></i>
                </div>
                <h2 class="fw-bold">{{ supplier_data|length }}</h2>
                <p class="mb-0 opacity-75">Verf√ºgbare Lieferanten</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 border-0" style="background: var(--warning-gradient); color: white;">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="fas fa-boxes"></i>
                </div>
                <h2 class="fw-bold" id="component-count">
                    {% for supplier_id, data in supplier_data.items %}
                        {% if forloop.first %}{{ data.prices|length }}{% endif %}
                    {% endfor %}
                </h2>
                <p class="mb-0 opacity-75">Komponenten verf√ºgbar</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card h-100 border-0" style="background: var(--danger-gradient); color: white;">
            <div class="card-body text-center">
                <div class="display-6 mb-3">
                    <i class="fas fa-calculator"></i>
                </div>
                <h2 class="fw-bold" id="stats-total">0.00‚Ç¨</h2>
                <p class="mb-0 opacity-75">Bestellwert gesamt</p>
            </div>
        </div>
    </div>
</div>

<!-- Selected Supplier Details -->
<div id="supplier-details" style="display: none;">
    <form id="procurement-form">
        {% csrf_token %}
        <div class="row mb-5" id="supplier-cards-container">
            <div class="col-12">
                <div class="card h-100 supplier-card">
                    <div class="card-header border-0 pb-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="fw-bold mb-1" id="supplier-name">
                                    <i class="fas fa-industry me-2"></i>
                                </h4>
                                <div class="supplier-badges" id="supplier-badges">
                                    <!-- Badges will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="supplier-total-display">
                                <span class="fs-4 fw-bold text-primary" id="supplier-total">0.00‚Ç¨</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="supplier-components">
                            <!-- Components table will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bestell√ºbersicht -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0" id="order-summary-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="fw-bold mb-1">
                                    <i class="fas fa-shopping-basket me-2"></i>Bestell√ºbersicht
                                </h3>
                                <p class="text-muted mb-0">Gesamtkosten Ihrer Bestellung</p>
                            </div>
                            <div class="text-end">
                                <div class="display-5 fw-bold text-primary mb-2" id="grand-total">0.00‚Ç¨</div>
                                <button type="submit" class="btn btn-primary btn-lg px-4">
                                    <i class="fas fa-paper-plane me-2"></i>Bestellung aufgeben
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Initial State Message -->
<div id="no-supplier-selected" class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="empty-state" style="opacity: 0.7;">
                    <div class="display-1 mb-4" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        <i class="fas fa-hand-point-up"></i>
                    </div>
                    <h3 class="fw-bold mb-3">Lieferant ausw√§hlen</h3>
                    <p class="text-muted mb-4">W√§hlen Sie oben einen Lieferanten aus, um mit der Bestellung zu beginnen.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not supplier_data %}
<!-- Empty State f√ºr keine Lieferanten -->
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="empty-state" style="opacity: 0.7;">
                    <div class="display-1 mb-4" style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        <i class="fas fa-store-slash"></i>
                    </div>
                    <h3 class="fw-bold mb-3">Keine Lieferanten verf√ºgbar</h3>
                    <p class="text-muted mb-4">Derzeit sind keine Lieferanten verf√ºgbar. Versuchen Sie es sp√§ter erneut.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Hidden supplier data for JavaScript -->
<script type="application/json" id="supplier-data">
{{ supplier_data_json|safe }}
</script>

<!-- Hidden bike component mapping for JavaScript -->
<script type="application/json" id="bike-component-mapping">
{{ bike_component_mapping|safe }}
</script>

{% endblock %}

{% block scripts %}
<!-- Load guide system core -->
<script src="{% static 'help_system/js/guide-system-core.js' %}"></script>

<!-- Load procurement tutorial system -->
<script src="{% static 'help_system/js/procurement-tutorial.js' %}"></script>

<!-- Check for pending guides -->
<script>
// Check if there's a pending guide to start
document.addEventListener('DOMContentLoaded', function() {
    const pendingGuideData = sessionStorage.getItem('pendingGuide');
    if (pendingGuideData) {
        try {
            const { guideId, guideData, timestamp } = JSON.parse(pendingGuideData);

            // Validate guide data structure
            if (!guideData || !guideData.title || !guideData.steps || !Array.isArray(guideData.steps)) {
                throw new Error('Ung√ºltige Anleitungsdaten erhalten');
            }

            console.log('üìã Guide data validated:', {
                title: guideData.title,
                steps: guideData.steps.length,
                timestamp: new Date(timestamp).toISOString()
            });

            // Check if the guide data is recent (within last 30 seconds)
            const now = Date.now();
            if (now - timestamp < 30000) {
                console.log('üéØ Pending guide detected, starting in 1.5 seconds...');

                // Remove from storage so it doesn't run again
                sessionStorage.removeItem('pendingGuide');

                // Wait for page to fully load, then start guide
                setTimeout(() => {
                    console.log('üé¨ Starting guide:', guideData.title);

                    // Detect if we're in a popup window
                    const isInPopup = window.opener && !window.opener.closed;
                    console.log('ü™ü Is in popup:', isInPopup);

                    // Start the guide (function loaded from guide-system-core.js)
                    if (typeof createInteractiveGuide !== 'undefined') {
                        createInteractiveGuide(guideData, 0, isInPopup);
                    } else {
                        console.error('‚ùå createInteractiveGuide function not found');
                        alert('Fehler: Guide-System konnte nicht geladen werden. Bitte laden Sie die Seite neu.');
                    }
                }, 1500);
            } else {
                console.log('‚è∞ Guide data is too old, removing...');
                sessionStorage.removeItem('pendingGuide');
            }
        } catch (error) {
            console.error('‚ùå Error loading pending guide:', error);
            sessionStorage.removeItem('pendingGuide');
            alert('Fehler beim Laden der Anleitung: ' + error.message);
        }
    } else {
        console.log('‚ÑπÔ∏è No pending guide found');
    }
});
</script>

<style>
.supplier-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.supplier-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border: 2px solid rgba(102, 126, 234, 0.3);
}

.component-icon {
    transition: all 0.3s ease;
}

.component-icon:hover {
    transform: scale(1.1);
}

.table tbody tr {
    transition: all 0.3s ease;
}

.table tbody tr:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
    transform: scale(1.01);
}

.procurement-input {
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
}

.procurement-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    transform: scale(1.05);
}

.supplier-badges .badge {
    transition: all 0.3s ease;
}

.supplier-badges .badge:hover {
    transform: scale(1.05);
}

.empty-state {
    animation: fadeInUp 0.6s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 0.7;
        transform: translateY(0);
    }
}

.btn {
    transition: all 0.3s ease;
}

.card {
    transition: all 0.3s ease;
}

.supplier-total-display {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

.dropdown-item {
    transition: all 0.3s ease;
}

.dropdown-item:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    transform: translateX(5px);
}

.supplier-info-badges .badge {
    font-size: 0.7rem;
}

/* Dropdown z-index fix - Enhanced for multiplayer mode */
/* Cards with transform/backdrop-filter create stacking contexts that trap dropdowns */
/* Using very high z-index to break free from card stacking contexts */
.dropdown-row {
    position: relative;
    z-index: 9990 !important;
    isolation: isolate;
}

/* Supplier dropdown should always be on top since it's selected first */
.supplier-dropdown-row {
    z-index: 10000 !important;
}

.dropdown-container {
    position: relative;
    z-index: 9995 !important;
}

.dropdown {
    position: relative;
    z-index: 9996 !important;
}

.dropdown-menu {
    z-index: 9999 !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25) !important;
    position: absolute !important;
}

/* Prevent stats cards from covering dropdown */
#stats-row {
    position: relative;
    z-index: 1 !important;
}

@media (max-width: 768px) {
    .display-4 {
        font-size: 2rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .supplier-badges {
        margin-top: 1rem;
    }
    
    .supplier-total-display {
        margin-top: 1rem;
    }
    
    .dropdown-menu {
        min-width: 100% !important;
    }
}

.quantity-input input::-webkit-outer-spin-button,
.quantity-input input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input input[type=number] {
    -moz-appearance: textfield;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get supplier data from Django
    const supplierDataElement = document.getElementById('supplier-data');
    let supplierData = {};

    // Get bike component mapping from Django
    const bikeComponentMappingElement = document.getElementById('bike-component-mapping');
    let bikeComponentMapping = {};

    if (supplierDataElement) {
        try {
            supplierData = JSON.parse(supplierDataElement.textContent);
            console.log('Supplier data loaded:', supplierData);
        } catch (e) {
            console.error('Error parsing supplier data:', e);
            console.log('Raw content:', supplierDataElement.textContent);
        }
    } else {
        console.error('supplier-data element not found');
    }
    
    if (bikeComponentMappingElement) {
        try {
            bikeComponentMapping = JSON.parse(bikeComponentMappingElement.textContent);
            console.log('Bike component mapping loaded:', bikeComponentMapping);
        } catch (e) {
            console.error('Error parsing bike component mapping:', e);
        }
    }
    
    const supplierDetails = document.getElementById('supplier-details');
    const noSupplierSelected = document.getElementById('no-supplier-selected');
    const selectedSupplierName = document.getElementById('selected-supplier-name');
    const supplierName = document.getElementById('supplier-name');
    const supplierBadges = document.getElementById('supplier-badges');
    const supplierComponents = document.getElementById('supplier-components');
    const componentCount = document.getElementById('component-count');
    
    let currentSupplier = null;
    let currentBikeTypeFilter = 'all';
    let procurementInputs = [];
    
    // Bike type filter handling
    const bikeTypeFilterRow = document.getElementById('bike-type-filter-row');
    const selectedBikeTypeName = document.getElementById('selected-bike-type-name');
    const bikeTypeOptions = document.querySelectorAll('.bike-type-option');
    
    bikeTypeOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const bikeTypeId = this.dataset.bikeTypeId;
            selectBikeTypeFilter(bikeTypeId);
            
            // Update visual selection
            bikeTypeOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    function selectBikeTypeFilter(bikeTypeId) {
        currentBikeTypeFilter = bikeTypeId;
        console.log('Selected bike type filter:', bikeTypeId);
        
        // Update button text
        const selectedOption = document.querySelector(`[data-bike-type-id="${bikeTypeId}"]`);
        if (selectedOption) {
            const optionText = selectedOption.querySelector('h6').textContent;
            selectedBikeTypeName.textContent = optionText;
        }
        
        // Update visual selection
        bikeTypeOptions.forEach(opt => opt.classList.remove('active'));
        if (selectedOption) {
            selectedOption.classList.add('active');
        }
        
        // Re-render supplier components with filter
        if (currentSupplier) {
            buildComponentsTable();
        }
    }
    
    // Make selectBikeTypeFilter globally accessible
    window.selectBikeTypeFilter = selectBikeTypeFilter;
    
    // Supplier selection handling
    console.log('Setting up supplier option handlers...');
    const supplierOptions = document.querySelectorAll('.supplier-option');
    console.log('Found supplier options:', supplierOptions.length);
    
    supplierOptions.forEach((option, index) => {
        console.log(`Setting up option ${index}:`, option.dataset.supplierId);
        option.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Supplier option clicked:', this.dataset.supplierId);
            const supplierId = this.dataset.supplierId;
            selectSupplier(supplierId);
        });
    });
    
    function selectSupplier(supplierId) {
        console.log('selectSupplier called with:', supplierId);
        console.log('Available supplier data:', Object.keys(supplierData));
        
        currentSupplier = supplierData[supplierId];
        console.log('Selected supplier:', currentSupplier);
        
        if (!currentSupplier) {
            console.error('Supplier not found:', supplierId);
            return;
        }
        
        // Update dropdown button text
        selectedSupplierName.textContent = currentSupplier.supplier.name;
        console.log('Updated dropdown button text to:', currentSupplier.supplier.name);
        
        // Show supplier details, hide no selection message
        supplierDetails.style.display = 'block';
        noSupplierSelected.style.display = 'none';
        
        // Update supplier info
        supplierName.innerHTML = `<i class="fas fa-industry me-2"></i>${currentSupplier.supplier.name}`;
        
        // Update badges
        let qualityBadge = '';
        let qualityIcon = '';
        if (currentSupplier.supplier.quality === 'basic') {
            qualityBadge = 'Basic Qualit√§t';
            qualityIcon = 'fas fa-star';
        } else if (currentSupplier.supplier.quality === 'standard') {
            qualityBadge = 'Standard Qualit√§t';
            qualityIcon = 'fas fa-star-half-alt';
        } else if (currentSupplier.supplier.quality === 'premium') {
            qualityBadge = 'Premium Qualit√§t';
            qualityIcon = 'fas fa-crown';
        }
        
        supplierBadges.innerHTML = `
            <span class="badge rounded-pill me-2" style="background: var(--success-gradient); color: white;">
                <i class="${qualityIcon} me-1"></i>${qualityBadge}
            </span>
            <span class="badge rounded-pill me-2" style="background: var(--primary-gradient); color: white;">
                <i class="fas fa-truck me-1"></i>${currentSupplier.supplier.delivery_time} Tage
            </span>
            <span class="badge rounded-pill" style="background: var(--warning-gradient); color: white;">
                <i class="fas fa-calendar me-1"></i>${currentSupplier.supplier.payment_terms} Tage Zahlungsziel
            </span>
        `;
        
        // Show bike type filter row
        bikeTypeFilterRow.style.display = 'block';
        
        // Build components table
        buildComponentsTable();
        
        // Reset totals
        updateTotals();
    }
    
    function buildComponentsTable() {
        if (!currentSupplier.prices || currentSupplier.prices.length === 0) {
            supplierComponents.innerHTML = `
                <div class="text-center py-4">
                    <div class="empty-state" style="opacity: 0.7;">
                        <i class="fas fa-exclamation-triangle display-4 text-warning mb-3"></i>
                        <h5 class="fw-bold mb-2">Keine Preise verf√ºgbar</h5>
                        <p class="text-muted mb-0">Dieser Lieferant hat derzeit keine Komponenten im Angebot.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        let tableHTML = `
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <tr>
                            <th class="border-0 fw-bold">Komponente</th>
                            <th class="border-0 fw-bold">Preis</th>
                            <th class="border-0 fw-bold">Menge</th>
                            <th class="border-0 fw-bold">Gesamt</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Filter components based on bike type selection
        let filteredPrices = currentSupplier.prices;
        if (currentBikeTypeFilter !== 'all' && bikeComponentMapping[currentBikeTypeFilter]) {
            const requiredComponentIds = bikeComponentMapping[currentBikeTypeFilter];
            console.log(`Filtering for bike type ${currentBikeTypeFilter}, required component IDs:`, requiredComponentIds);
            filteredPrices = currentSupplier.prices.filter(price => 
                requiredComponentIds.includes(price.component.id)
            );
            console.log(`Filtered from ${currentSupplier.prices.length} to ${filteredPrices.length} components`);
        }
        
        // Update component count with filtered count
        componentCount.textContent = filteredPrices.length;
        
        // If no components after filtering, show appropriate message
        if (filteredPrices.length === 0) {
            const bikeTypeName = currentBikeTypeFilter === 'all' ? 'alle Fahrradtypen' : 
                document.querySelector(`[data-bike-type-id="${currentBikeTypeFilter}"] h6`).textContent;
            
            // Check if bike type has any component requirements at all
            const hasComponentRequirements = bikeComponentMapping[currentBikeTypeFilter] && 
                                           bikeComponentMapping[currentBikeTypeFilter].length > 0;
            
            let message = '';
            if (currentBikeTypeFilter === 'all') {
                message = 'Dieser Lieferant hat derzeit keine Komponenten im Angebot.';
            } else if (!hasComponentRequirements) {
                message = `F√ºr ${bikeTypeName} sind noch keine Komponenten-Anforderungen definiert. W√§hlen Sie "Alle Komponenten" um alle verf√ºgbaren Komponenten zu sehen.`;
            } else {
                message = `Dieser Lieferant bietet keine kompatiblen Komponenten f√ºr ${bikeTypeName} an.`;
            }
            
            supplierComponents.innerHTML = `
                <div class="text-center py-4">
                    <div class="empty-state" style="opacity: 0.7;">
                        <i class="fas fa-filter display-4 text-info mb-3"></i>
                        <h5 class="fw-bold mb-2">Keine passenden Komponenten</h5>
                        <p class="text-muted mb-0">${message}</p>
                        ${!hasComponentRequirements && currentBikeTypeFilter !== 'all' ? 
                            '<button class="btn btn-outline-primary mt-2" onclick="selectBikeTypeFilter(\'all\')">Alle Komponenten anzeigen</button>' : ''
                        }
                    </div>
                </div>
            `;
            return;
        }
        
        filteredPrices.forEach(price => {
            tableHTML += `
                <tr class="border-bottom">
                    <td class="py-3">
                        <div class="d-flex align-items-center">
                            <div class="component-icon me-3" style="width: 35px; height: 35px; background: var(--primary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem;">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${price.component.component_type.name}</div>
                                <small class="text-muted">${price.component.name}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="fw-bold text-success">${parseFloat(price.price).toFixed(2)}‚Ç¨</span>
                    </td>
                    <td>
                        <div class="quantity-input">
                            <input type="number" 
                                   class="form-control procurement-input" 
                                   min="0" 
                                   value="0"
                                   data-supplier="${currentSupplier.supplier.id}"
                                   data-component="${price.component.id}"
                                   data-price="${price.price}"
                                   placeholder="0">
                        </div>
                    </td>
                    <td>
                        <span class="fw-bold text-primary total-cell">0.00‚Ç¨</span>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += '</tbody></table></div>';
        supplierComponents.innerHTML = tableHTML;
        
        // Update procurement inputs reference and add event listeners
        procurementInputs = document.querySelectorAll('.procurement-input');
        procurementInputs.forEach(input => {
            input.addEventListener('input', updateTotals);
        });
    }
    
    function updateTotals() {
        let supplierTotal = 0;
        
        // Update individual row totals
        procurementInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const total = quantity * price;
            
            const totalCell = input.closest('tr').querySelector('.total-cell');
            if (totalCell) {
                totalCell.textContent = total.toFixed(2) + '‚Ç¨';
            }
            
            supplierTotal += total;
        });
        
        // Update supplier total
        document.getElementById('supplier-total').textContent = supplierTotal.toFixed(2) + '‚Ç¨';
        
        // Update grand total (same as supplier total since we only show one supplier)
        document.getElementById('grand-total').textContent = supplierTotal.toFixed(2) + '‚Ç¨';
        document.getElementById('stats-total').textContent = supplierTotal.toFixed(2) + '‚Ç¨';
    }
    
    // Form submission handling
    document.getElementById('procurement-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentSupplier) {
            alert('Bitte w√§hlen Sie zuerst einen Lieferanten aus.');
            return;
        }
        
        const orderData = {};
        let hasItems = false;
        
        procurementInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                hasItems = true;
                const supplierId = input.dataset.supplier;
                const componentId = input.dataset.component;
                
                if (!orderData[supplierId]) {
                    orderData[supplierId] = [];
                }
                
                orderData[supplierId].push({
                    component_id: componentId,
                    quantity: quantity
                });
            }
        });
        
        if (!hasItems) {
            alert('Bitte w√§hlen Sie mindestens eine Komponente aus.');
            return;
        }
        
        fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten.');
        });
    });
});
</script>
{% endblock %}