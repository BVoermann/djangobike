{% extends 'base.html' %}
{% load math_filters %}

{% block title %}Einkauf{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Einkauf</h2>
        <p>Bestellen Sie Komponenten von Ihren Lieferanten.</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>Aktuelles Guthaben:</strong> {{ session.balance|floatformat:2 }}€
        </div>
    </div>
</div>

<form id="procurement-form">
    {% csrf_token %}
    <div class="row">
        {% for supplier_id, data in supplier_data.items %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>{{ data.supplier.name }}</h5>
                    <small class="text-muted">
                        Qualität: {{ data.supplier.get_quality_display }} | 
                        Lieferzeit: {{ data.supplier.delivery_time }} Tage | 
                        Zahlungsziel: {{ data.supplier.payment_terms }} Tage
                    </small>
                </div>
                <div class="card-body">
                    {% if data.prices %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Komponente</th>
                                    <th>Preis</th>
                                    <th>Menge</th>
                                    <th>Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for price in data.prices %}
                                <tr>
                                    <td>
                                        {{ price.component.component_type.name }}<br>
                                        <small class="text-muted">{{ price.component.name }}</small>
                                    </td>
                                    <td>{{ price.price|floatformat:2 }}€</td>
                                    <td>
                                        <input type="number" 
                                               class="form-control form-control-sm procurement-input" 
                                               min="0" 
                                               value="0"
                                               data-supplier="{{ supplier_id }}"
                                               data-component="{{ price.component.id }}"
                                               data-price="{{ price.price }}">
                                    </td>
                                    <td class="total-cell">0.00€</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3">Lieferant Gesamt:</th>
                                    <th class="supplier-total">0.00€</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Keine Preise verfügbar.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Gesamtkosten: <span id="grand-total">0.00€</span></h5>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-shopping-cart"></i> Bestellung aufgeben
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const procurementInputs = document.querySelectorAll('.procurement-input');
    
    procurementInputs.forEach(input => {
        input.addEventListener('input', updateTotals);
    });
    
    function updateTotals() {
        let grandTotal = 0;
        
        // Update individual row totals
        procurementInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price);
            const total = quantity * price;
            
            const totalCell = input.closest('tr').querySelector('.total-cell');
            totalCell.textContent = total.toFixed(2) + '€';
        });
        
        // Update supplier totals
        const suppliers = new Set();
        procurementInputs.forEach(input => {
            suppliers.add(input.dataset.supplier);
        });
        
        suppliers.forEach(supplierId => {
            let supplierTotal = 0;
            const supplierInputs = document.querySelectorAll(`[data-supplier="${supplierId}"]`);
            
            supplierInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price);
                supplierTotal += quantity * price;
            });
            
            const supplierTotalCell = supplierInputs[0].closest('.card').querySelector('.supplier-total');
            supplierTotalCell.textContent = supplierTotal.toFixed(2) + '€';
            
            grandTotal += supplierTotal;
        });
        
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2) + '€';
    }
    
    document.getElementById('procurement-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const orderData = {};
        
        procurementInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                const supplierId = input.dataset.supplier;
                const componentId = input.dataset.component;
                
                if (!orderData[supplierId]) {
                    orderData[supplierId] = [];
                }
                
                orderData[supplierId].push({
                    component_id: componentId,
                    quantity: quantity
                });
            }
        });
        
        if (Object.keys(orderData).length === 0) {
            alert('Bitte wählen Sie mindestens eine Komponente aus.');
            return;
        }
        
        fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    });
});
</script>
{% endblock %} 